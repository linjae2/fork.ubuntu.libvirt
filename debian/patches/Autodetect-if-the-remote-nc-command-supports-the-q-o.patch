From: =?UTF-8?q?Guido=20G=C3=BCnther?= <agx@sigxcpu.org>
Date: Wed, 6 Oct 2010 18:12:46 +0200
Subject: Autodetect if the remote nc command supports the -q option

Author: Marc Deslauriers <marc.deslauriers@ubuntu.com>
Origin: other, based on http://hg.fedorahosted.org/hg/virt-manager/rev/1f781890ea4a
Origin: other, based on http://hg.fedorahosted.org/hg/virt-manager/rev/f09702cfdb03
Origin: other, based on http://hg.fedorahosted.org/hg/virt-manager/rev/907ee61e5558
Origin: other, based on http://hg.fedorahosted.org/hg/virt-manager/rev/16fcbf77e47e
Origin: other, based on http://git.fedorahosted.org/git/?p=virt-manager.git;a=commit;h=d078def94fda124304da95733d41844384e739ad
Bug-Ubuntu: https://bugs.launchpad.net/ubuntu/+source/libvirt/+bug/517478
Bug-Ubuntu: https://bugs.launchpad.net/ubuntu/+source/virt-manager/+bug/605172
Bug-Ubuntu: https://bugs.launchpad.net/ubuntu/+source/libvirt/+bug/792985
Bug: https://bugzilla.redhat.com/show_bug.cgi?id=562176
Bug: https://bugzilla.redhat.com/show_bug.cgi?id=614420
---
 src/remote/remote_driver.c |   34 +++++++++++++++++++++++++++++-----
 1 files changed, 29 insertions(+), 5 deletions(-)

Index: libvirt-0.9.2/src/remote/remote_driver.c
===================================================================
--- libvirt-0.9.2.orig/src/remote/remote_driver.c	2011-08-16 13:27:54.922550114 -0400
+++ libvirt-0.9.2/src/remote/remote_driver.c	2011-08-16 13:28:46.252550463 -0400
@@ -774,12 +774,36 @@
             virCommandAddArgList(cmd, "-T", "-o", "BatchMode=yes", "-e",
                                  "none", NULL);
         }
-        virCommandAddArgList(cmd, priv->hostname, netcat ? netcat : "nc",
-                             "-U", (sockname ? sockname :
-                                    (flags & VIR_CONNECT_RO
-                                     ? LIBVIRTD_PRIV_UNIX_SOCKET_RO
-                                     : LIBVIRTD_PRIV_UNIX_SOCKET)), NULL);
 
+        virCommandAddArgList(cmd, priv->hostname, "sh -c", NULL);
+        /*
+         * This ugly thing is a shell script to detect availability of
+         * the -q option for 'nc': debian and suse based distros need this
+         * flag to ensure the remote nc will exit on EOF, so it will go away
+         * when we close the VNC tunnel. If it doesn't go away, subsequent
+         * VNC connection attempts will hang.
+         *
+         * Fedora's 'nc' doesn't have this option, and apparently defaults
+         * to the desired behavior.
+         */
+        virCommandAddArgFormat(cmd, "'%s -q 2>&1 | grep \"requires an argument\" >/dev/null;"
+                               "if [ $? -eq 0 ] ; then"
+                               "   CMD=\"%s -q 0 -U %s\";"
+                               "else"
+                               "   CMD=\"%s -U %s\";"
+                               "fi;"
+                               "eval \"$CMD\";'",
+                               netcat ? netcat : "nc",
+                               netcat ? netcat : "nc",
+                               sockname ? sockname :
+                                (flags & VIR_CONNECT_RO
+                                 ? LIBVIRTD_PRIV_UNIX_SOCKET_RO
+                                 : LIBVIRTD_PRIV_UNIX_SOCKET),
+                               netcat ? netcat : "nc",
+                               sockname ? sockname :
+                                (flags & VIR_CONNECT_RO
+                                 ? LIBVIRTD_PRIV_UNIX_SOCKET_RO
+                                 : LIBVIRTD_PRIV_UNIX_SOCKET));
         priv->is_secure = 1;
     }
 
