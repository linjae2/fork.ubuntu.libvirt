Description: fix denial of service via keepalive feature
Origin: upstream, http://libvirt.org/git/?p=libvirt.git;a=commit;h=173c2914734eb5c32df6d35a82bf503e12261bcf
Origin: upstream, http://libvirt.org/git/?p=libvirt.git;a=commit;h=066c8ef6c18bc1faf8b3e10787b39796a7a06cc0
Bug-Debian: http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=735676
Bug-Redhat: https://bugzilla.redhat.com/show_bug.cgi?id=1047577

Index: libvirt-1.1.1/src/rpc/virnetserverclient.c
===================================================================
--- libvirt-1.1.1.orig/src/rpc/virnetserverclient.c	2014-03-25 14:15:24.082627483 -0500
+++ libvirt-1.1.1/src/rpc/virnetserverclient.c	2014-03-25 14:15:24.074627483 -0500
@@ -1533,9 +1533,22 @@ cleanup:
 int
 virNetServerClientStartKeepAlive(virNetServerClientPtr client)
 {
-    int ret;
+    int ret = -1;
+
     virObjectLock(client);
+
+    /* The connection might have been closed before we got here and thus the
+     * keepalive object could have been removed too.
+     */
+    if (!client->keepalive) {
+        virReportError(VIR_ERR_INTERNAL_ERROR, "%s",
+                       _("connection not open"));
+        goto cleanup;
+    }
+
     ret = virKeepAliveStart(client->keepalive, 0, 0);
+
+cleanup:
     virObjectUnlock(client);
     return ret;
 }
