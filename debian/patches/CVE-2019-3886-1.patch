From 2a07c990bd9143d7a0fe8d1b6b7c763c52185240 Mon Sep 17 00:00:00 2001
From: =?utf8?q?Daniel=20P.=20Berrang=C3=A9?= <berrange@redhat.com>
Date: Wed, 27 Mar 2019 10:59:58 +0000
Subject: [PATCH] api: disallow virDomainGetHostname for read-only connections
MIME-Version: 1.0
Content-Type: text/plain; charset=utf8
Content-Transfer-Encoding: 8bit

The virDomainGetHostname API is fetching guest information and this may
involve use of an untrusted guest agent. As such its use must be
forbidden on a read-only connection to libvirt.

Fixes CVE-2019-3886
Reviewed-by: Jim Fehlig <jfehlig@suse.com>
Signed-off-by: Daniel P. BerrangÃ© <berrange@redhat.com>
---
 src/libvirt-domain.c |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

Index: libvirt-5.0.0/src/libvirt-domain.c
===================================================================
--- libvirt-5.0.0.orig/src/libvirt-domain.c	2019-06-17 07:17:57.898874011 -0400
+++ libvirt-5.0.0/src/libvirt-domain.c	2019-06-17 07:17:57.894873985 -0400
@@ -11028,6 +11028,8 @@ virDomainGetHostname(virDomainPtr domain
     virCheckDomainReturn(domain, NULL);
     conn = domain->conn;
 
+    virCheckReadOnlyGoto(domain->conn->flags, error);
+
     if (conn->driver->domainGetHostname) {
         char *ret;
         ret = conn->driver->domainGetHostname(domain, flags);
