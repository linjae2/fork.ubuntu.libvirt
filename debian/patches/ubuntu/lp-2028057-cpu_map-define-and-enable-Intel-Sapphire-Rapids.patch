From 96c8d39af007000daf3d5dfa845365f66379aaac Mon Sep 17 00:00:00 2001
From: Lin Yang <lin.a.yang@intel.com>
Date: Wed, 17 May 2023 17:30:57 -0700
Subject: [PATCH] cpu_map: Add SapphireRapids CPU model

Signed-off-by: Lin Yang <lin.a.yang@intel.com>
Signed-off-by: Tim Wiederhake <twiederh@redhat.com>
Reviewed-by: Tim Wiederhake <twiederh@redhat.com>

Origin: upstream, https://gitlab.com/libvirt/libvirt/-/commit/96c8d39af007000daf3d5dfa845365f66379aaac
Bug-Ubuntu: https://bugs.launchpad.net/bugs/2028057
Last-Update: 2023-10-27

--- a/src/cpu_map/index.xml
+++ b/src/cpu_map/index.xml
@@ -56,6 +56,7 @@
     <include filename='x86_Icelake-Server-noTSX.xml'/>
     <include filename='x86_Cooperlake.xml'/>
     <include filename='x86_Snowridge.xml'/>
+    <include filename='x86_SapphireRapids.xml'/>
 
     <!-- AMD CPUs -->
     <include filename='x86_athlon.xml'/>
--- a/src/cpu_map/meson.build
+++ b/src/cpu_map/meson.build
@@ -72,6 +72,7 @@
   'x86_qemu64.xml',
   'x86_SandyBridge-IBRS.xml',
   'x86_SandyBridge.xml',
+  'x86_SapphireRapids.xml',
   'x86_Skylake-Client-IBRS.xml',
   'x86_Skylake-Client-noTSX-IBRS.xml',
   'x86_Skylake-Client.xml',
--- /dev/null
+++ b/src/cpu_map/x86_SapphireRapids.xml
@@ -0,0 +1,116 @@
+<cpus>
+  <model name='SapphireRapids'>
+    <decode host='on' guest='on'/>
+    <signature family='6' model='143'/>
+    <vendor name='Intel'/>
+    <feature name='3dnowprefetch'/>
+    <feature name='abm'/>
+    <feature name='adx'/>
+    <feature name='aes'/>
+    <feature name='amx-bf16'/>
+    <feature name='amx-int8'/>
+    <feature name='amx-tile'/>
+    <feature name='apic'/>
+    <feature name='arat'/>
+    <feature name='arch-capabilities'/>
+    <feature name='avx'/>
+    <feature name='avx-vnni'/>
+    <feature name='avx2'/>
+    <feature name='avx512-bf16'/>
+    <feature name='avx512-fp16'/>
+    <feature name='avx512-vpopcntdq'/>
+    <feature name='avx512bitalg'/>
+    <feature name='avx512bw'/>
+    <feature name='avx512cd'/>
+    <feature name='avx512dq'/>
+    <feature name='avx512f'/>
+    <feature name='avx512ifma'/>
+    <feature name='avx512vbmi'/>
+    <feature name='avx512vbmi2'/>
+    <feature name='avx512vl'/>
+    <feature name='avx512vnni'/>
+    <feature name='bmi1'/>
+    <feature name='bmi2'/>
+    <feature name='bus-lock-detect'/>
+    <feature name='clflush'/>
+    <feature name='clflushopt'/>
+    <feature name='clwb'/>
+    <feature name='cmov'/>
+    <feature name='cx16'/>
+    <feature name='cx8'/>
+    <feature name='de'/>
+    <feature name='erms'/>
+    <feature name='f16c'/>
+    <feature name='fma'/>
+    <feature name='fpu'/>
+    <feature name='fsgsbase'/>
+    <feature name='fsrc'/>
+    <feature name='fsrm'/>
+    <feature name='fsrs'/>
+    <feature name='fxsr'/>
+    <feature name='fzrm'/>
+    <feature name='gfni'/>
+    <feature name='hle'/>
+    <feature name='ibrs-all'/>
+    <feature name='invpcid'/>
+    <feature name='la57'/>
+    <feature name='lahf_lm'/>
+    <feature name='lm'/>
+    <feature name='mca'/>
+    <feature name='mce'/>
+    <feature name='mds-no'/>
+    <feature name='mmx'/>
+    <feature name='movbe'/>
+    <feature name='msr'/>
+    <feature name='mtrr'/>
+    <feature name='nx'/>
+    <feature name='pae'/>
+    <feature name='pat'/>
+    <feature name='pcid'/>
+    <feature name='pclmuldq'/>
+    <feature name='pdpe1gb'/>
+    <feature name='pge'/>
+    <feature name='pku'/>
+    <feature name='pni'/>
+    <feature name='popcnt'/>
+    <feature name='pschange-mc-no'/>
+    <feature name='pse'/>
+    <feature name='pse36'/>
+    <feature name='rdctl-no'/>
+    <feature name='rdpid'/>
+    <feature name='rdrand'/>
+    <feature name='rdseed'/>
+    <feature name='rdtscp'/>
+    <feature name='rtm'/>
+    <feature name='sep'/>
+    <feature name='serialize'/>
+    <feature name='sha-ni'/>
+    <feature name='skip-l1dfl-vmentry'/>
+    <feature name='smap'/>
+    <feature name='smep'/>
+    <feature name='spec-ctrl'/>
+    <feature name='ssbd'/>
+    <feature name='sse'/>
+    <feature name='sse2'/>
+    <feature name='sse4.1'/>
+    <feature name='sse4.2'/>
+    <feature name='ssse3'/>
+    <feature name='syscall'/>
+    <feature name='taa-no'/>
+    <feature name='tsc'/>
+    <feature name='tsc-deadline'/>
+    <feature name='tsx-ldtrk'/>
+    <feature name='umip'/>
+    <feature name='vaes'/>
+    <feature name='vme'/>
+    <feature name='vpclmulqdq'/>
+    <feature name='wbnoinvd'/>
+    <feature name='x2apic'/>
+    <feature name='xfd'/>
+    <feature name='xgetbv1'/>
+    <feature name='xsave'/>
+    <feature name='xsavec'/>
+    <feature name='xsaveopt'/>
+    <feature name='xsaves'/>
+  </model>
+</cpus>
--- a/tests/domaincapsdata/qemu_8.0.0-q35.x86_64.xml
+++ b/tests/domaincapsdata/qemu_8.0.0-q35.x86_64.xml
@@ -91,6 +91,7 @@
       <model usable='no' vendor='Intel'>Skylake-Client-noTSX-IBRS</model>
       <model usable='no' vendor='Intel'>Skylake-Client-IBRS</model>
       <model usable='no' vendor='Intel'>Skylake-Client</model>
+      <model usable='no' vendor='Intel'>SapphireRapids</model>
       <model usable='no' vendor='Intel'>SandyBridge-IBRS</model>
       <model usable='yes' vendor='Intel'>SandyBridge</model>
       <model usable='yes' vendor='Intel'>Penryn</model>
--- a/tests/domaincapsdata/qemu_8.0.0-tcg.x86_64.xml
+++ b/tests/domaincapsdata/qemu_8.0.0-tcg.x86_64.xml
@@ -93,6 +93,7 @@
       <model usable='no' vendor='Intel'>Skylake-Client-noTSX-IBRS</model>
       <model usable='no' vendor='Intel'>Skylake-Client-IBRS</model>
       <model usable='no' vendor='Intel'>Skylake-Client</model>
+      <model usable='no' vendor='Intel'>SapphireRapids</model>
       <model usable='no' vendor='Intel'>SandyBridge-IBRS</model>
       <model usable='no' vendor='Intel'>SandyBridge</model>
       <model usable='yes' vendor='Intel'>Penryn</model>
--- a/tests/domaincapsdata/qemu_8.0.0.x86_64.xml
+++ b/tests/domaincapsdata/qemu_8.0.0.x86_64.xml
@@ -90,6 +90,7 @@
       <model usable='no' vendor='Intel'>Skylake-Client-noTSX-IBRS</model>
       <model usable='no' vendor='Intel'>Skylake-Client-IBRS</model>
       <model usable='no' vendor='Intel'>Skylake-Client</model>
+      <model usable='no' vendor='Intel'>SapphireRapids</model>
       <model usable='no' vendor='Intel'>SandyBridge-IBRS</model>
       <model usable='yes' vendor='Intel'>SandyBridge</model>
       <model usable='yes' vendor='Intel'>Penryn</model>
