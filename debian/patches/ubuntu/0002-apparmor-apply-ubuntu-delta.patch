Subject: [PATCH 0002/0004] Merge Ubuntu changes and local templates

Index: libvirt/examples/Makefile.am
===================================================================
--- libvirt.orig/examples/Makefile.am	2016-08-08 14:12:17.690334559 +0200
+++ libvirt/examples/Makefile.am	2016-08-08 14:12:17.670334559 +0200
@@ -24,6 +24,8 @@ BUILT_SOURCES =
 EXTRA_DIST = \
 	apparmor/TEMPLATE.qemu \
 	apparmor/TEMPLATE.lxc \
+	apparmor/local-usr.sbin.libvirtd \
+	apparmor/local-usr.lib.libvirt.virt-aa-helper \
 	lxcconvert/virt-lxc-convert \
 	polkit/libvirt-acl.rules \
 	systemtap/events.stp \
@@ -79,6 +81,18 @@ apparmor_DATA = \
 	apparmor/usr.sbin.libvirtd \
 	$(NULL)
 
+localdir = $(apparmordir)/local
+local_DATA = \
+	apparmor/local-usr.sbin.libvirtd \
+	apparmor/local-usr.lib.libvirt.virt-aa-helper \
+	$(NULL)
+
+install-data-hook:
+	mv $(DESTDIR)$(localdir)/local-usr.sbin.libvirtd \
+	   $(DESTDIR)$(localdir)/usr.sbin.libvirtd
+	mv $(DESTDIR)$(localdir)/local-usr.lib.libvirt.virt-aa-helper \
+	   $(DESTDIR)$(localdir)/usr.lib.libvirt.virt-aa-helper
+
 abstractionsdir = $(apparmordir)/abstractions
 abstractions_DATA = \
 	apparmor/libvirt-qemu \
Index: libvirt/examples/apparmor/TEMPLATE.lxc
===================================================================
--- libvirt.orig/examples/apparmor/TEMPLATE.lxc	2016-08-08 14:12:17.690334559 +0200
+++ libvirt/examples/apparmor/TEMPLATE.lxc	2016-08-08 14:12:17.686334559 +0200
@@ -4,12 +4,18 @@
 
 #include <tunables/global>
 
-profile LIBVIRT_TEMPLATE {
+profile LIBVIRT_TEMPLATE (attach_disconnected,mediate_deleted) {
   #include <abstractions/libvirt-lxc>
 
-  # Globally allows everything to run under this profile
-  # These can be narrowed depending on the container's use.
+  # Globally allows everything to run under this profile. This is fine-tuned via
+  # via abstractions/libvirt-lxc and can be narrowed depending on the
+  # container's use.
   file,
   capability,
   network,
+
+  # the container may never be allowed to mount devpts.  If it does, it
+  # will remount the host's devpts.  We could allow it to do it with
+  # the newinstance option (but, right now, we don't).
+  deny mount fstype=devpts,
 }
Index: libvirt/examples/apparmor/libvirt-lxc.in
===================================================================
--- libvirt.orig/examples/apparmor/libvirt-lxc.in	2016-08-08 14:12:17.690334559 +0200
+++ libvirt/examples/apparmor/libvirt-lxc.in	2016-08-08 14:12:17.686334559 +0200
@@ -1,15 +1,31 @@
-# Last Modified: Fri Feb  7 13:01:36 2014
+# Last Modified: Mon, 23 May 2016 14:47:41 +0200
 
   #include <abstractions/base>
 
   umount,
 
+@@ifge 2009
+  # This also needs additional rules to reach outside of the container via
+  # DBus, so just let all of DBus within the container.
+  dbus,
+
+  # Allow libvirtd to signal us
+  signal (receive) peer=/usr/sbin/libvirtd,
+
+  # Allow us to ptrace ourselves
+  ptrace peer=@{profile_name},
+
+@@end
   # ignore DENIED message on / remount
   deny mount options=(ro, remount) -> /,
+  deny mount options=(ro, remount, silent) -> /,
 
   # allow tmpfs mounts everywhere
   mount fstype=tmpfs,
 
+  # allow hugetlbfs mounts everywhere
+  mount fstype=hugetlbfs,
+
   # allow mqueue mounts everywhere
   mount fstype=mqueue,
 
@@ -33,10 +49,18 @@
   mount fstype=fusectl -> /sys/fs/fuse/connections/,
   mount fstype=securityfs -> /sys/kernel/security/,
   mount fstype=debugfs -> /sys/kernel/debug/,
+  deny mount fstype=debugfs -> /var/lib/ureadahead/debugfs/,
   mount fstype=proc -> /proc/,
   mount fstype=sysfs -> /sys/,
   deny /sys/firmware/efi/efivars/** rwklx,
   deny /sys/kernel/security/** rwklx,
+  # support use of cgmanager proxy
+  mount options=(move) /sys/fs/cgroup/cgmanager/ -> /sys/fs/cgroup/cgmanager.lower/,
+
+  mount options=(rw nosuid nodev noexec remount) -> /sys/,
+  mount options=(rw remount) -> /sys/kernel/security/,
+  mount options=(rw remount) -> /sys/fs/pstore/,
+  mount options=(ro remount) -> /sys/fs/pstore/,
 
   # generated by: lxc-generate-aa-rules.py container-rules.base
   deny /proc/sys/[^kn]*{,/**} wklx,
Index: libvirt/examples/apparmor/libvirt-qemu.in
===================================================================
--- libvirt.orig/examples/apparmor/libvirt-qemu.in	2016-08-08 14:12:17.690334559 +0200
+++ libvirt/examples/apparmor/libvirt-qemu.in	2016-08-08 14:12:17.686334559 +0200
@@ -1,4 +1,4 @@
-# Last Modified: Wed Sep 3 21:52:03 2014
+# Last Modified: Mon, 23 May 2016 14:52:41 +0200
 
   #include <abstractions/base>
   #include <abstractions/consoles>
@@ -13,15 +13,28 @@
   capability setgid,
   capability setuid,
 
+  # this is needed with libcap-ng support, however it breaks a lot of things
+  # atm, so just silence the denial until libcap-ng works right. LP: #522845
+  deny capability setpcap,
+
   network inet stream,
   network inet6 stream,
 
   /dev/net/tun rw,
+  /dev/tap* rw,
   /dev/kvm rw,
   /dev/ptmx rw,
   /dev/kqemu rw,
   @{PROC}/*/status r,
   @{PROC}/sys/kernel/cap_last_cap r,
+  owner @{PROC}/*/auxv r,
+  @{PROC}/sys/vm/overcommit_memory r,
+
+  /sys/devices/system/node/ r,
+  /sys/devices/system/node/node[0-9]*/meminfo r,
+  /sys/devices/system/cpu/ r,
+
+  /sys/module/vhost/parameters/max_mem_regions r,
 
   # For hostdev access. The actual devices will be added dynamically
   /sys/bus/usb/devices/ r,
@@ -38,6 +51,9 @@
   /dev/snd/* rw,
   capability ipc_lock,
   # spice
+  /usr/bin/qemu-system-i386-spice rmix,
+  /usr/bin/qemu-system-x86_64-spice rmix,
+  /{dev,run}/shm/ r,
   owner /{dev,run}/shm/spice.* rw,
   # 'kill' is not required for sound and is a security risk. Do not enable
   # unless you absolutely need it.
@@ -66,10 +82,12 @@
   /usr/share/proll/** r,
   /usr/share/vgabios/** r,
   /usr/share/seabios/** r,
+  /usr/share/misc/sgabios.bin r,
   /usr/share/ovmf/** r,
   /usr/share/OVMF/** r,
   /usr/share/AAVMF/** r,
   /usr/share/qemu-efi/** r,
+  /usr/share/slof/** r,
 
   # access PKI infrastructure
   /etc/pki/libvirt-vnc/** r,
@@ -95,6 +113,7 @@
   /usr/bin/qemu-system-or32 rmix,
   /usr/bin/qemu-system-ppc rmix,
   /usr/bin/qemu-system-ppc64 rmix,
+  /usr/bin/qemu-system-ppc64le rmix,
   /usr/bin/qemu-system-ppcemb rmix,
   /usr/bin/qemu-system-s390x rmix,
   /usr/bin/qemu-system-sh4 rmix,
@@ -104,6 +123,7 @@
   /usr/bin/qemu-system-tricore rmix,
   /usr/bin/qemu-system-unicore32 rmix,
   /usr/bin/qemu-system-x86_64 rmix,
+  /usr/bin/qemu-system-x86_64-spice rmix,
   /usr/bin/qemu-system-xtensa rmix,
   /usr/bin/qemu-system-xtensaeb rmix,
   /usr/bin/qemu-aarch64 rmix,
@@ -131,20 +151,36 @@
   /usr/bin/qemu-sh4 rmix,
   /usr/bin/qemu-sh4eb rmix,
   /usr/bin/qemu-sparc rmix,
+  /usr/bin/qemu-sparc64 rmix,
   /usr/bin/qemu-sparc32plus rmix,
   /usr/bin/qemu-sparc64 rmix,
   /usr/bin/qemu-unicore32 rmix,
   /usr/bin/qemu-x86_64 rmix,
-  /usr/{lib,lib64}/qemu/block-curl.so mr,
-  /usr/{lib,lib64}/qemu/block-rbd.so mr,
 
   # for save and resume
+  /bin/bash rmix,
   /bin/dash rmix,
   /bin/dd rmix,
   /bin/cat rmix,
+  /etc/pki/CA/ r,
+  /etc/pki/CA/* r,
+  /etc/pki/libvirt/ r,
+  /etc/pki/libvirt/** r,
 
-  # for restore
-  /bin/bash rmix,
+  # kvm.powerpc executes this
+  /bin/uname rmix,
+
+  # for rbd
+  /etc/ceph/ceph.conf r,
+
+  # for qemu-block-extra
+  /usr/{lib,lib64}/qemu/block-curl.so mr,
+  /usr/{lib,lib64}/qemu/block-rbd.so mr,
+  /usr/lib/@{multiarch}/qemu/*.so rm,
+
+  # for access to hugepages
+  owner "/run/hugepages/kvm/libvirt/qemu/**" rw,
+  owner "/dev/hugepages/libvirt/qemu/**" rw,
 
   # for usb access
   /dev/bus/usb/ r,
@@ -152,6 +188,30 @@
   /sys/bus/ r,
   /sys/class/ r,
 
+@@ifge 2009
+  signal (receive) peer=/usr/sbin/libvirtd,
+  ptrace (tracedby) peer=/usr/sbin/libvirtd,
+@@end
+
+  # for ppc device-tree access
+  @{PROC}/device-tree/ r,
+  @{PROC}/device-tree/** r,
+  /sys/firmware/devicetree/** r,
+
+  # allow access to charm-specific ceph config (see lp#1403648)
+  /var/lib/charm/*/ceph.conf r,
+  # silence spurious denials (see lp#1403648)
+  deny /tmp/{,**} r,
+  deny /var/tmp/{,**} r,
+
+  # silence refusals to open lttng files (see lp#1432644)
+  deny /dev/shm/lttng-ust-wait-* r,
+  deny /run/shm/lttng-ust-wait-* r,
+
+  # allow serial console backed by pts chardev (LP: #1342083)
+  /usr/lib/pt_chown ix,
+  owner @{PROC}/0-9*/fd/ r,
+
   /usr/{lib,libexec}/qemu-bridge-helper Cx -> qemu_bridge_helper,
   # child profile for bridge helper process
   profile qemu_bridge_helper {
@@ -162,6 +222,10 @@
    capability setpcap,
    capability net_admin,
 
+   # for 9p
+   capability fsetid,
+   capability fowner,
+
    network inet stream,
 
    /dev/net/tun rw,
Index: libvirt/examples/apparmor/local-usr.sbin.libvirtd
===================================================================
--- /dev/null	1970-01-01 00:00:00.000000000 +0000
+++ libvirt/examples/apparmor/local-usr.sbin.libvirtd	2016-08-08 14:12:17.686334559 +0200
@@ -0,0 +1,2 @@
+# Site-specific additions and overrides for usr.sbin.libvirtd.
+# For more details, please see /etc/apparmor.d/local/README.
Index: libvirt/examples/apparmor/usr.lib.libvirt.virt-aa-helper.in
===================================================================
--- libvirt.orig/examples/apparmor/usr.lib.libvirt.virt-aa-helper.in	2016-08-08 14:12:17.690334559 +0200
+++ libvirt/examples/apparmor/usr.lib.libvirt.virt-aa-helper.in	2016-08-08 14:12:17.686334559 +0200
@@ -1,8 +1,11 @@
-# Last Modified: Mon Apr  5 15:10:27 2010
+# Last Modified: Mon, 23 May 2016 15:00:13 +0200
 #include <tunables/global>
 
-profile virt-aa-helper /usr/{lib,lib64}/libvirt/virt-aa-helper {
+/usr/{lib,lib64}/libvirt/virt-aa-helper {
   #include <abstractions/base>
+  #include <abstractions/user-tmp>
+  # Site-specific additions and overrides. See local/README for details.
+  #include <local/usr.lib.libvirt.virt-aa-helper>
 
   # needed for searching directories
   capability dac_override,
@@ -10,6 +13,7 @@ profile virt-aa-helper /usr/{lib,lib64}/
 
   # needed for when disk is on a network filesystem
   network inet,
+  network inet6,
 
   deny @{PROC}/[0-9]*/mounts r,
   @{PROC}/[0-9]*/net/psched r,
@@ -21,8 +25,9 @@ profile virt-aa-helper /usr/{lib,lib64}/
   # for hostdev
   /sys/devices/ r,
   /sys/devices/** r,
+  /sys/bus/usb/devices/ r,
+  /sys/bus/usb/devices/** r,
   deny /dev/sd* r,
-  deny /dev/vd* r,
   deny /dev/dm-* r,
   deny /dev/mapper/ r,
   deny /dev/mapper/* r,
@@ -30,20 +35,33 @@ profile virt-aa-helper /usr/{lib,lib64}/
   /usr/{lib,lib64}/libvirt/virt-aa-helper mr,
   /sbin/apparmor_parser Ux,
 
+  # for openvswitch
+  /{,var/}run/** rw,
+
   /etc/apparmor.d/libvirt/* r,
   /etc/apparmor.d/libvirt/libvirt-[0-9a-f]*-[0-9a-f]*-[0-9a-f]*-[0-9a-f]*-[0-9a-f]* rw,
 
-  # for backingstore -- allow access to non-hidden files in @{HOME} as well
-  # as storage pools
+  # For backingstore, virt-aa-helper needs to peek inside the disk image, so
+  # allow access to non-hidden files in @{HOME} as well as storage pools, and
+  # removable media and filesystems, and certain file extentions. A
+  # virt-aa-helper failure when checking a disk for backinsgstore is non-fatal
+  # (but obviously the backingstore won't be added).
   audit deny @{HOME}/.* mrwkl,
   audit deny @{HOME}/.*/ rw,
   audit deny @{HOME}/.*/** mrwkl,
-  audit deny @{HOME}/bin/ rw,
-  audit deny @{HOME}/bin/** mrwkl,
   @{HOME}/ r,
   @{HOME}/** r,
+  @{HOME}/.Private/** mrwlk,
+  @{HOMEDIRS}/.ecryptfs/*/.Private/** mrwlk,
+
   /var/lib/libvirt/images/ r,
   /var/lib/libvirt/images/** r,
+  /var/lib/nova/images/** r,
+  /var/lib/nova/instances/_base/** r,
+  /var/lib/nova/instances/snapshots/** r,
+  /var/lib/eucalyptus/instances/**/disk* r,
+  /var/lib/eucalyptus/instances/**/loader* r,
+  /var/lib/uvtool/libvirt/images/** r,
   /{media,mnt,opt,srv}/** r,
 
   /**.img r,
@@ -52,7 +70,4 @@ profile virt-aa-helper /usr/{lib,lib64}/
   /**.vmdk r,
   /**.[iI][sS][oO] r,
   /**/disk{,.*} r,
-
-  # Site-specific additions and overrides. See local/README for details.
-  #include <local/usr.lib.libvirt.virt-aa-helper>
 }
Index: libvirt/examples/apparmor/usr.sbin.libvirtd.in
===================================================================
--- libvirt.orig/examples/apparmor/usr.sbin.libvirtd.in	2016-08-08 14:12:17.690334559 +0200
+++ libvirt/examples/apparmor/usr.sbin.libvirtd.in	2016-08-08 14:12:17.686334559 +0200
@@ -1,10 +1,12 @@
-# Last Modified: Mon Apr  5 15:03:58 2010
+# Last Modified: Mon, 23 May 2016 15:06:33 +0200
 #include <tunables/global>
 @{LIBVIRT}="libvirt"
 
 /usr/sbin/libvirtd {
   #include <abstractions/base>
   #include <abstractions/dbus>
+  # Site-specific additions and overrides. See local/README for details.
+  #include <local/usr.sbin.libvirtd>
 
   capability kill,
   capability net_admin,
@@ -36,9 +38,21 @@
   network inet6 dgram,
   network packet dgram,
   network packet raw,
+@@ifge 2009
+  network netlink,
+@@end
+
+@@ifge 2009
+  dbus bus=system,
+  signal,
+  ptrace,
+@@end
+@@ifge 2009
+  unix,
+@@end
 
-  # Very lenient profile for libvirtd since we want to first focus on confining
-  # the guests. Guests will have a very restricted profile.
+  # For now, use a very lenient profile since we want to first focus on
+  # confining the guests
   / r,
   /** rwmkl,
 
@@ -49,7 +63,12 @@
   /usr/sbin/* PUx,
   /lib/udev/scsi_id PUx,
   /usr/{lib,lib64}/xen-common/bin/xen-toolstack PUx,
-  /usr/{lib,lib64}/xen/bin/* Ux,
+  /usr/{lib,lib64}/xen-*/bin/pygrub PUx,
+  /usr/{lib,lib64}/xen-*/bin/libxl-save-helper PUx,
+
+  # Required by nwfilter_ebiptables_driver.c:ebiptablesWriteToTempFile() to
+  # write and run an ebtables script.
+  /var/lib/libvirt/virtd* ixr,
 
   # force the use of virt-aa-helper
   audit deny /sbin/apparmor_parser rwxl,
@@ -59,14 +78,10 @@
   audit deny /sys/kernel/security/apparmor/.* rwxl,
   /sys/kernel/security/apparmor/profiles r,
   /usr/{lib,lib64}/libvirt/* PUxr,
-  /usr/{lib,lib64}/libvirt/libvirt_parthelper ix,
-  /usr/{lib,lib64}/libvirt/libvirt_iohelper ix,
   /etc/libvirt/hooks/** rmix,
   /etc/xen/scripts/** rmix,
 
   # allow changing to our UUID-based named profiles
   change_profile -> @{LIBVIRT}-[0-9a-f]*-[0-9a-f]*-[0-9a-f]*-[0-9a-f]*-[0-9a-f]*,
 
-  # Site-specific additions and overrides. See local/README for details.
-  #include <local/usr.sbin.libvirtd>
 }
Index: libvirt/examples/apparmor/local-usr.lib.libvirt.virt-aa-helper
===================================================================
--- /dev/null	1970-01-01 00:00:00.000000000 +0000
+++ libvirt/examples/apparmor/local-usr.lib.libvirt.virt-aa-helper	2016-08-08 14:12:17.686334559 +0200
@@ -0,0 +1,2 @@
+# Site-specific additions and overrides for usr.lib.libvirt.virt-aa-helper.
+# For more details, please see /etc/apparmor.d/local/README.
