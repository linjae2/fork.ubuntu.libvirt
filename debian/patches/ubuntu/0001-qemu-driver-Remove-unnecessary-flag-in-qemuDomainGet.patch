From fc6b75e3b028403b53f3421d089bb469690686ba Mon Sep 17 00:00:00 2001
From: Peter Krempa <pkrempa@redhat.com>
Date: Wed, 18 May 2016 14:17:07 +0200
Subject: [PATCH 1/3] qemu: driver: Remove unnecessary flag in
 qemuDomainGetStatsBlock

'abbreviated' was true if 'stats' were NULL
---
 src/qemu/qemu_driver.c | 15 +++++----------
 1 file changed, 5 insertions(+), 10 deletions(-)

Bug: upstream, https://libvirt.org/git/?p=libvirt.git;a=commit;h=5d2b0e6f12b4e57d75ed1047ab1c36443b7a54b3
Bug-Ubuntu: https://bugs.launchpad.net/bugs/1746630
Bug-Redhat: https://bugzilla.redhat.com/show_bug.cgi?id=1337073
Index: libvirt-1.3.1/src/qemu/qemu_driver.c
===================================================================
--- libvirt-1.3.1.orig/src/qemu/qemu_driver.c	2017-11-21 20:19:36.558768378 -0800
+++ libvirt-1.3.1/src/qemu/qemu_driver.c	2018-01-31 16:38:35.000000000 -0800
@@ -19238,7 +19238,6 @@
                            virStorageSourcePtr src,
                            size_t block_idx,
                            unsigned int backing_idx,
-                           bool abbreviated,
                            virHashTablePtr stats)
 {
     qemuBlockStats *entry;
@@ -19257,7 +19256,7 @@
         QEMU_ADD_BLOCK_PARAM_UI(record, maxparams, block_idx, "backingIndex",
                                 backing_idx);
 
-    if (abbreviated || !alias || !(entry = virHashLookup(stats, alias))) {
+    if (!stats || !alias || !(entry = virHashLookup(stats, alias))) {
         if (virStorageSourceIsEmpty(src)) {
             ret = 0;
             goto cleanup;
@@ -19334,15 +19333,12 @@
     int rc;
     virHashTablePtr stats = NULL;
     qemuDomainObjPrivatePtr priv = dom->privateData;
-    bool abbreviated = false;
     virQEMUDriverConfigPtr cfg = virQEMUDriverGetConfig(driver);
     int count_index = -1;
     size_t visited = 0;
     bool visitBacking = !!(privflags & QEMU_DOMAIN_STATS_BACKING);
 
-    if (!HAVE_JOB(privflags) || !virDomainObjIsActive(dom)) {
-        abbreviated = true; /* it's ok, just go ahead silently */
-    } else {
+    if (HAVE_JOB(privflags) && virDomainObjIsActive(dom)) {
         qemuDomainObjEnterMonitor(driver, dom);
         rc = qemuMonitorGetAllBlockStatsInfo(priv->mon, &stats,
                                              visitBacking);
@@ -19352,10 +19348,9 @@
         if (qemuDomainObjExitMonitor(driver, dom) < 0)
             goto cleanup;
 
-        if (rc < 0) {
+        /* failure to retrieve stats is fine at this point */
+        if (rc < 0)
             virResetLastError();
-            abbreviated = true; /* still ok, again go ahead silently */
-        }
     }
 
     /* When listing backing chains, it's easier to fix up the count
@@ -19372,7 +19367,7 @@
         while (src && (backing_idx == 0 || visitBacking)) {
             if (qemuDomainGetStatsOneBlock(driver, cfg, dom, record, maxparams,
                                            disk, src, visited, backing_idx,
-                                           abbreviated, stats) < 0)
+                                           stats) < 0)
                 goto cleanup;
             visited++;
             backing_idx++;
