Backport of:

From 8b605530e80a13b44d8a05f5718a3edab18d3ff5 Mon Sep 17 00:00:00 2001
From: Paolo Bonzini <pbonzini@redhat.com>
Date: Tue, 12 Dec 2017 16:23:42 +0100
Subject: [PATCH] cpu: add CPU features for indirect branch prediction
 protection

Added in QEMU commits TBD and TBD.

Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
Signed-off-by: Jiri Denemark <jdenemar@redhat.com>
Reviewed-by: Pavel Hrdina <phrdina@redhat.com>
---
 src/cpu/cpu_map.xml | 8 ++++++++
 1 file changed, 8 insertions(+)

Index: libvirt-1.3.1/src/cpu/cpu_map.xml
===================================================================
--- libvirt-1.3.1.orig/src/cpu/cpu_map.xml	2018-01-25 13:52:59.668751266 -0500
+++ libvirt-1.3.1/src/cpu/cpu_map.xml	2018-01-25 13:56:21.860945291 -0500
@@ -287,6 +287,9 @@
     <feature name='perfctr_nb'>
       <cpuid function='0x80000001' ecx='0x01000000'/>
     </feature>
+    <feature name='spec-ctrl'>
+      <cpuid function='0x07' edx='0x04000000'/>
+    </feature>
 
     <!-- cpuid function 0x7 ecx 0x0 features -->
     <!-- We support only ecx 0x0 now as it's done by a workaround -->
@@ -347,6 +350,11 @@
       <cpuid function='0x80000007' edx='0x00000100'/>
     </feature>
 
+    <!-- More AMD-specific features -->
+    <feature name='ibpb'>
+      <cpuid function='0x80000008' ebx='0x00001000'/>
+    </feature>
+
     <!-- models -->
     <model name='486'>
       <feature name='fpu'/>
