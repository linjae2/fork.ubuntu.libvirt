Description: fix denial of service via crafted XML document
Origin: backport, http://libvirt.org/git/?p=libvirt.git;a=commit;h=be7a5de9d0c406f36efae3230e1743c613ad6945

Index: libvirt-0.7.5/src/conf/domain_conf.c
===================================================================
--- libvirt-0.7.5.orig/src/conf/domain_conf.c	2014-09-29 15:49:20.096983010 -0400
+++ libvirt-0.7.5/src/conf/domain_conf.c	2014-09-29 15:57:09.040995568 -0400
@@ -2615,7 +2615,7 @@
     virDomainDeviceDefPtr dev = NULL;
 
     if (!(xml = xmlReadDoc(BAD_CAST xmlStr, "device.xml", NULL,
-                           XML_PARSE_NOENT | XML_PARSE_NONET |
+                           XML_PARSE_NONET |
                            XML_PARSE_NOERROR | XML_PARSE_NOWARNING))) {
         virDomainReportError(conn, VIR_ERR_XML_ERROR, NULL);
         goto error;
@@ -3500,7 +3500,7 @@
 
     if (conn) virResetError (&conn->err);
     xml = xmlCtxtReadDoc (pctxt, BAD_CAST xmlStr, "domain.xml", NULL,
-                          XML_PARSE_NOENT | XML_PARSE_NONET |
+                          XML_PARSE_NONET |
                           XML_PARSE_NOWARNING);
     if (!xml) {
         if (virGetLastError() == NULL)
@@ -3541,7 +3541,7 @@
 
     if (conn) virResetError (&conn->err);
     xml = xmlCtxtReadFile (pctxt, filename, NULL,
-                           XML_PARSE_NOENT | XML_PARSE_NONET |
+                           XML_PARSE_NONET |
                            XML_PARSE_NOWARNING);
     if (!xml) {
         if (virGetLastError() == NULL)
@@ -3613,7 +3613,7 @@
 
     if (conn) virResetError (&conn->err);
     xml = xmlCtxtReadFile (pctxt, filename, NULL,
-                           XML_PARSE_NOENT | XML_PARSE_NONET |
+                           XML_PARSE_NONET |
                            XML_PARSE_NOWARNING);
     if (!xml) {
         if (virGetLastError() == NULL)
Index: libvirt-0.7.5/src/conf/interface_conf.c
===================================================================
--- libvirt-0.7.5.orig/src/conf/interface_conf.c	2009-12-22 04:37:57.000000000 -0500
+++ libvirt-0.7.5/src/conf/interface_conf.c	2014-09-29 15:56:43.600994887 -0400
@@ -923,7 +923,7 @@
 
     if (conn) virResetError (&conn->err);
     xml = xmlCtxtReadDoc (pctxt, BAD_CAST xmlStr, "interface.xml", NULL,
-                          XML_PARSE_NOENT | XML_PARSE_NONET |
+                          XML_PARSE_NONET |
                           XML_PARSE_NOWARNING);
     if (!xml) {
         if (conn && conn->err.code == VIR_ERR_NONE)
@@ -963,7 +963,7 @@
 
     if (conn) virResetError (&conn->err);
     xml = xmlCtxtReadFile (pctxt, filename, NULL,
-                           XML_PARSE_NOENT | XML_PARSE_NONET |
+                           XML_PARSE_NONET |
                            XML_PARSE_NOWARNING);
     if (!xml) {
         if (conn && conn->err.code == VIR_ERR_NONE)
Index: libvirt-0.7.5/src/conf/network_conf.c
===================================================================
--- libvirt-0.7.5.orig/src/conf/network_conf.c	2014-09-29 15:49:20.164983012 -0400
+++ libvirt-0.7.5/src/conf/network_conf.c	2014-09-29 15:57:25.396996006 -0400
@@ -546,7 +546,7 @@
 
     if (conn) virResetError (&conn->err);
     xml = xmlCtxtReadDoc (pctxt, BAD_CAST xmlStr, "network.xml", NULL,
-                          XML_PARSE_NOENT | XML_PARSE_NONET |
+                          XML_PARSE_NONET |
                           XML_PARSE_NOWARNING);
     if (!xml) {
         if (conn && conn->err.code == VIR_ERR_NONE)
@@ -586,7 +586,7 @@
 
     if (conn) virResetError (&conn->err);
     xml = xmlCtxtReadFile (pctxt, filename, NULL,
-                           XML_PARSE_NOENT | XML_PARSE_NONET |
+                           XML_PARSE_NONET |
                            XML_PARSE_NOWARNING);
     if (!xml) {
         if (conn && conn->err.code == VIR_ERR_NONE)
Index: libvirt-0.7.5/src/conf/node_device_conf.c
===================================================================
--- libvirt-0.7.5.orig/src/conf/node_device_conf.c	2009-12-22 04:37:57.000000000 -0500
+++ libvirt-0.7.5/src/conf/node_device_conf.c	2014-09-29 15:57:54.736996792 -0400
@@ -1281,12 +1281,12 @@
     if (conn) virResetError (&conn->err);
     if (filename) {
         xml = xmlCtxtReadFile (pctxt, filename, NULL,
-                               XML_PARSE_NOENT | XML_PARSE_NONET |
+                               XML_PARSE_NONET |
                                XML_PARSE_NOWARNING);
     } else {
         xml = xmlCtxtReadDoc (pctxt, BAD_CAST str,
                               "device.xml", NULL,
-                              XML_PARSE_NOENT | XML_PARSE_NONET |
+                              XML_PARSE_NONET |
                               XML_PARSE_NOWARNING);
     }
 
Index: libvirt-0.7.5/src/conf/secret_conf.c
===================================================================
--- libvirt-0.7.5.orig/src/conf/secret_conf.c	2009-12-22 04:37:57.000000000 -0500
+++ libvirt-0.7.5/src/conf/secret_conf.c	2014-09-29 15:54:47.736991784 -0400
@@ -222,11 +222,11 @@
 
     if (filename != NULL)
         xml = xmlCtxtReadFile(pctxt, filename, NULL,
-                              XML_PARSE_NOENT | XML_PARSE_NONET |
+                              XML_PARSE_NONET |
                               XML_PARSE_NOWARNING);
     else
         xml = xmlCtxtReadDoc(pctxt, BAD_CAST xmlStr, "secret.xml", NULL,
-                             XML_PARSE_NOENT | XML_PARSE_NONET |
+                             XML_PARSE_NONET |
                              XML_PARSE_NOWARNING);
     if (xml == NULL) {
         if (conn->err.code == VIR_ERR_NONE)
Index: libvirt-0.7.5/src/conf/storage_conf.c
===================================================================
--- libvirt-0.7.5.orig/src/conf/storage_conf.c	2009-12-22 04:37:57.000000000 -0500
+++ libvirt-0.7.5/src/conf/storage_conf.c	2014-09-29 15:58:24.668997593 -0400
@@ -485,7 +485,7 @@
     virStoragePoolSourcePtr def = NULL, ret = NULL;
 
     doc = xmlReadDoc((const xmlChar *)srcSpec, "srcSpec.xml", NULL,
-                     XML_PARSE_NOENT | XML_PARSE_NONET |
+                     XML_PARSE_NONET |
                      XML_PARSE_NOERROR | XML_PARSE_NOWARNING);
 
     if (doc == NULL) {
@@ -778,12 +778,12 @@
     if (conn) virResetError (&conn->err);
     if (filename) {
         xml = xmlCtxtReadFile (pctxt, filename, NULL,
-                               XML_PARSE_NOENT | XML_PARSE_NONET |
+                               XML_PARSE_NONET |
                                XML_PARSE_NOWARNING);
     } else {
         xml = xmlCtxtReadDoc (pctxt, BAD_CAST xmlStr,
                               "storage.xml", NULL,
-                              XML_PARSE_NOENT | XML_PARSE_NONET |
+                              XML_PARSE_NONET |
                               XML_PARSE_NOWARNING);
     }
 
@@ -1188,12 +1188,12 @@
 
     if (filename) {
         xml = xmlCtxtReadFile (pctxt, filename, NULL,
-                               XML_PARSE_NOENT | XML_PARSE_NONET |
+                               XML_PARSE_NONET |
                                XML_PARSE_NOWARNING);
     } else {
         xml = xmlCtxtReadDoc (pctxt, BAD_CAST xmlStr,
                               "storage.xml", NULL,
-                              XML_PARSE_NOENT | XML_PARSE_NONET |
+                              XML_PARSE_NONET |
                               XML_PARSE_NOWARNING);
     }
 
Index: libvirt-0.7.5/src/security/virt-aa-helper.c
===================================================================
--- libvirt-0.7.5.orig/src/security/virt-aa-helper.c	2014-09-29 15:49:20.024983008 -0400
+++ libvirt-0.7.5/src/security/virt-aa-helper.c	2014-09-29 15:56:28.428994480 -0400
@@ -620,7 +620,7 @@
     pctxt->sax->error = catchXMLError;
 
     xml = xmlCtxtReadDoc (pctxt, BAD_CAST xmlStr, "domain.xml", NULL,
-                          XML_PARSE_NOENT | XML_PARSE_NONET |
+                          XML_PARSE_NONET |
                           XML_PARSE_NOWARNING);
     if (!xml) {
         if (virGetLastError() == NULL)
Index: libvirt-0.7.5/src/test/test_driver.c
===================================================================
--- libvirt-0.7.5.orig/src/test/test_driver.c	2009-12-22 04:37:57.000000000 -0500
+++ libvirt-0.7.5/src/test/test_driver.c	2014-09-29 15:56:17.504994188 -0400
@@ -773,7 +773,7 @@
     }
 
     if (!(xml = xmlReadFd(fd, file, NULL,
-                          XML_PARSE_NOENT | XML_PARSE_NONET |
+                          XML_PARSE_NONET |
                           XML_PARSE_NOERROR | XML_PARSE_NOWARNING))) {
         testError(NULL, VIR_ERR_INTERNAL_ERROR,
                   _("Invalid XML in file '%s'"), file);
Index: libvirt-0.7.5/tools/virsh.c
===================================================================
--- libvirt-0.7.5.orig/tools/virsh.c	2014-09-29 15:49:19.592982997 -0400
+++ libvirt-0.7.5/tools/virsh.c	2014-09-29 15:55:39.380993167 -0400
@@ -557,7 +557,7 @@
         goto cleanup;
 
     xml = xmlReadDoc((const xmlChar *) doc, "domain.xml", NULL,
-                     XML_PARSE_NOENT | XML_PARSE_NONET |
+                     XML_PARSE_NONET |
                      XML_PARSE_NOWARNING);
     free(doc);
     if (!xml)
@@ -4947,7 +4947,7 @@
     int size;
 
     doc = xmlReadDoc((const xmlChar *) origxml, "domain.xml", NULL,
-                     XML_PARSE_NOENT | XML_PARSE_NONET | XML_PARSE_NOWARNING);
+                     XML_PARSE_NONET | XML_PARSE_NOWARNING);
     if (!doc)
         goto cleanup;
     ctxt = xmlXPathNewContext(doc);
@@ -6171,7 +6171,7 @@
         goto cleanup;
 
     xml = xmlReadDoc((const xmlChar *) doc, "domain.xml", NULL,
-                     XML_PARSE_NOENT | XML_PARSE_NONET |
+                     XML_PARSE_NONET |
                      XML_PARSE_NOWARNING);
     free(doc);
     if (!xml)
@@ -6245,7 +6245,7 @@
         goto cleanup;
 
     xml = xmlReadDoc((const xmlChar *) doc, "domain.xml", NULL,
-                     XML_PARSE_NOENT | XML_PARSE_NONET |
+                     XML_PARSE_NONET |
                      XML_PARSE_NOWARNING);
     free(doc);
     if (!xml)
@@ -6549,7 +6549,7 @@
         goto cleanup;
 
     xml = xmlReadDoc((const xmlChar *) doc, "domain.xml", NULL,
-                     XML_PARSE_NOENT | XML_PARSE_NONET |
+                     XML_PARSE_NONET |
                      XML_PARSE_NOWARNING);
     free(doc);
     if (!xml) {
@@ -6822,7 +6822,7 @@
         goto cleanup;
 
     xml = xmlReadDoc((const xmlChar *) doc, "domain.xml", NULL,
-                     XML_PARSE_NOENT | XML_PARSE_NONET |
+                     XML_PARSE_NONET |
                      XML_PARSE_NOWARNING);
     free(doc);
     if (!xml) {
