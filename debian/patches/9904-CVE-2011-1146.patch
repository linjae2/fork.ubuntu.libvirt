Origin: 71753cb7f7a16ff800381c0b5ee4e99eea92fed3
Description: Add missing checks for read only connections. Patch adapted from
 upstream for the following entry points:
  - virConnectDomainXMLToNative
  - virNodeDeviceDettach
  - virNodeDeviceReAttach
  - virNodeDeviceReset

Bug: https://bugzilla.redhat.com/show_bug.cgi?id=683650
Bug-Debian: http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=617773

Index: libvirt-0.7.5/src/libvirt.c
===================================================================
--- libvirt-0.7.5.orig/src/libvirt.c	2011-03-15 16:06:03.000000000 -0500
+++ libvirt-0.7.5/src/libvirt.c	2011-03-15 16:06:50.000000000 -0500
@@ -2985,6 +2985,11 @@
         return (NULL);
     }
 
+    if (conn->flags & VIR_CONNECT_RO) {
+        virLibConnError(conn, VIR_ERR_OPERATION_DENIED, __FUNCTION__);
+        goto error;
+    }
+
     if (nativeFormat == NULL || domainXml == NULL) {
         virLibConnError(conn, VIR_ERR_INVALID_ARG, __FUNCTION__);
         return (NULL);
@@ -8858,6 +8863,11 @@
         return (-1);
     }
 
+    if (dev->conn->flags & VIR_CONNECT_RO) {
+        virLibConnError(dev->conn, VIR_ERR_OPERATION_DENIED, __FUNCTION__);
+        goto error;
+    }
+
     if (dev->conn->driver->nodeDeviceDettach) {
         int ret;
         ret = dev->conn->driver->nodeDeviceDettach (dev);
@@ -8901,6 +8911,11 @@
         return (-1);
     }
 
+    if (dev->conn->flags & VIR_CONNECT_RO) {
+        virLibConnError(dev->conn, VIR_ERR_OPERATION_DENIED, __FUNCTION__);
+        goto error;
+    }
+
     if (dev->conn->driver->nodeDeviceReAttach) {
         int ret;
         ret = dev->conn->driver->nodeDeviceReAttach (dev);
@@ -8946,6 +8961,11 @@
         return (-1);
     }
 
+    if (dev->conn->flags & VIR_CONNECT_RO) {
+        virLibConnError(dev->conn, VIR_ERR_OPERATION_DENIED, __FUNCTION__);
+        goto error;
+    }
+
     if (dev->conn->driver->nodeDeviceReset) {
         int ret;
         ret = dev->conn->driver->nodeDeviceReset (dev);
