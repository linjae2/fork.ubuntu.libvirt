Origin: 71753cb7f7a16ff800381c0b5ee4e99eea92fed3
Description: Add missing checks for read only connections. Patch adapted from
 upstream for the following entry points:
  - virConnectDomainXMLToNative
  - virNodeDeviceDettach
  - virNodeDeviceReAttach
  - virNodeDeviceReset

Bug: https://bugzilla.redhat.com/show_bug.cgi?id=683650
Bug-Debian: http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=617773

Index: libvirt-0.7.0/src/libvirt.c
===================================================================
--- libvirt-0.7.0.orig/src/libvirt.c	2009-08-05 07:50:00.000000000 -0500
+++ libvirt-0.7.0/src/libvirt.c	2011-03-15 16:18:46.000000000 -0500
@@ -2845,6 +2845,11 @@
         return (NULL);
     }
 
+    if (conn->flags & VIR_CONNECT_RO) {
+        virLibConnError(conn, VIR_ERR_OPERATION_DENIED, __FUNCTION__);
+        goto error;
+    }
+
     if (nativeFormat == NULL || domainXml == NULL) {
         virLibConnError(conn, VIR_ERR_INVALID_ARG, __FUNCTION__);
         return (NULL);
@@ -8306,6 +8311,11 @@
         return (-1);
     }
 
+    if (dev->conn->flags & VIR_CONNECT_RO) {
+        virLibConnError(dev->conn, VIR_ERR_OPERATION_DENIED, __FUNCTION__);
+        goto error;
+    }
+
     if (dev->conn->driver->nodeDeviceDettach) {
         int ret;
         ret = dev->conn->driver->nodeDeviceDettach (dev);
@@ -8349,6 +8359,11 @@
         return (-1);
     }
 
+    if (dev->conn->flags & VIR_CONNECT_RO) {
+        virLibConnError(dev->conn, VIR_ERR_OPERATION_DENIED, __FUNCTION__);
+        goto error;
+    }
+
     if (dev->conn->driver->nodeDeviceReAttach) {
         int ret;
         ret = dev->conn->driver->nodeDeviceReAttach (dev);
@@ -8394,6 +8409,11 @@
         return (-1);
     }
 
+    if (dev->conn->flags & VIR_CONNECT_RO) {
+        virLibConnError(dev->conn, VIR_ERR_OPERATION_DENIED, __FUNCTION__);
+        goto error;
+    }
+
     if (dev->conn->driver->nodeDeviceReset) {
         int ret;
         ret = dev->conn->driver->nodeDeviceReset (dev);
