From aed6a032cead4386472afb24b16196579e239580 Mon Sep 17 00:00:00 2001
From: =?utf8?q?J=C3=A1n=20Tomko?= <jtomko@redhat.com>
Date: Fri, 14 Jun 2019 08:47:42 +0200
Subject: [PATCH] api: disallow virDomainSaveImageGetXMLDesc on read-only connections
MIME-Version: 1.0
Content-Type: text/plain; charset=utf8
Content-Transfer-Encoding: 8bit

The virDomainSaveImageGetXMLDesc API is taking a path parameter,
which can point to any path on the system. This file will then be
read and parsed by libvirtd running with root privileges.

Forbid it on read-only connections.

Fixes: CVE-2019-10161
Reported-by: Matthias Gerstner <mgerstner@suse.de>
Signed-off-by: JÃ¡n Tomko <jtomko@redhat.com>
Reviewed-by: Daniel P. BerrangÃ© <berrange@redhat.com>
---
 src/libvirt-domain.c         |   11 ++---------
 src/qemu/qemu_driver.c       |    2 +-
 src/remote/remote_protocol.x |    3 +--
 3 files changed, 4 insertions(+), 12 deletions(-)

Index: libvirt-5.4.0/src/libvirt-domain.c
===================================================================
--- libvirt-5.4.0.orig/src/libvirt-domain.c	2019-07-02 08:07:11.273742204 -0400
+++ libvirt-5.4.0/src/libvirt-domain.c	2019-07-02 08:07:11.269742150 -0400
@@ -1073,8 +1073,7 @@ virDomainRestoreFlags(virConnectPtr conn
  * previously by virDomainSave() or virDomainSaveFlags().
  *
  * No security-sensitive data will be included unless @flags contains
- * VIR_DOMAIN_SAVE_IMAGE_XML_SECURE; this flag is rejected on read-only
- * connections.
+ * VIR_DOMAIN_SAVE_IMAGE_XML_SECURE.
  *
  * Returns a 0 terminated UTF-8 encoded XML instance, or NULL in case of
  * error.  The caller must free() the returned value.
@@ -1090,13 +1089,7 @@ virDomainSaveImageGetXMLDesc(virConnectP
 
     virCheckConnectReturn(conn, NULL);
     virCheckNonNullArgGoto(file, error);
-
-    if ((conn->flags & VIR_CONNECT_RO) &&
-        (flags & VIR_DOMAIN_SAVE_IMAGE_XML_SECURE)) {
-        virReportError(VIR_ERR_OPERATION_DENIED, "%s",
-                       _("virDomainSaveImageGetXMLDesc with secure flag"));
-        goto error;
-    }
+    virCheckReadOnlyGoto(conn->flags, error);
 
     if (conn->driver->domainSaveImageGetXMLDesc) {
         char *ret;
Index: libvirt-5.4.0/src/qemu/qemu_driver.c
===================================================================
--- libvirt-5.4.0.orig/src/qemu/qemu_driver.c	2019-07-02 08:07:11.273742204 -0400
+++ libvirt-5.4.0/src/qemu/qemu_driver.c	2019-07-02 08:07:11.269742150 -0400
@@ -7038,7 +7038,7 @@ qemuDomainSaveImageGetXMLDesc(virConnect
     if (fd < 0)
         goto cleanup;
 
-    if (virDomainSaveImageGetXMLDescEnsureACL(conn, def, flags) < 0)
+    if (virDomainSaveImageGetXMLDescEnsureACL(conn, def) < 0)
         goto cleanup;
 
     ret = qemuDomainDefFormatXML(driver, def, flags);
Index: libvirt-5.4.0/src/remote/remote_protocol.x
===================================================================
--- libvirt-5.4.0.orig/src/remote/remote_protocol.x	2019-07-02 08:07:11.273742204 -0400
+++ libvirt-5.4.0/src/remote/remote_protocol.x	2019-07-02 08:07:11.273742204 -0400
@@ -5242,8 +5242,7 @@ enum remote_procedure {
     /**
      * @generate: both
      * @priority: high
-     * @acl: domain:read
-     * @acl: domain:read_secure:VIR_DOMAIN_SAVE_IMAGE_XML_SECURE
+     * @acl: domain:write
      */
     REMOTE_PROC_DOMAIN_SAVE_IMAGE_GET_XML_DESC = 235,
 
