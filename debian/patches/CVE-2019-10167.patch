From 58f237d696310f3ac62e98b3b5e9cb98e13064e9 Mon Sep 17 00:00:00 2001
From: =?utf8?q?J=C3=A1n=20Tomko?= <jtomko@redhat.com>
Date: Fri, 14 Jun 2019 09:16:14 +0200
Subject: [PATCH] api: disallow virConnectGetDomainCapabilities on read-only connections
MIME-Version: 1.0
Content-Type: text/plain; charset=utf8
Content-Transfer-Encoding: 8bit

This API can be used to execute arbitrary emulators.
Forbid it on read-only connections.

Fixes: CVE-2019-10167
Signed-off-by: JÃ¡n Tomko <jtomko@redhat.com>
Reviewed-by: Daniel P. BerrangÃ© <berrange@redhat.com>
(cherry picked from commit 8afa68bac0cf99d1f8aaa6566685c43c22622f26)
Signed-off-by: JÃ¡n Tomko <jtomko@redhat.com>
---
 src/libvirt-domain.c |    1 +
 1 files changed, 1 insertions(+), 0 deletions(-)

Index: libvirt-5.0.0/src/libvirt-domain.c
===================================================================
--- libvirt-5.0.0.orig/src/libvirt-domain.c	2019-07-02 08:49:36.997785260 -0400
+++ libvirt-5.0.0/src/libvirt-domain.c	2019-07-02 08:49:36.997785260 -0400
@@ -11359,6 +11359,7 @@ virConnectGetDomainCapabilities(virConne
     virResetLastError();
 
     virCheckConnectReturn(conn, NULL);
+    virCheckReadOnlyGoto(conn->flags, error);
 
     if (conn->driver->connectGetDomainCapabilities) {
         char *ret;
