Backport of:

From 04bbaa2b1f828b83faea03041f246c14770726db Mon Sep 17 00:00:00 2001
From: Peter Krempa <pkrempa@redhat.com>
Date: Tue, 30 Nov 2021 11:34:43 +0100
Subject: [PATCH] libxlLoggerNew: Avoid virHashFree by rearranging code
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Allocate the hash table only after the log file is opened so that we
don't need to deallocate it on failure.

Signed-off-by: Peter Krempa <pkrempa@redhat.com>
Reviewed-by: JÃ¡n Tomko <jtomko@redhat.com>
Reviewed-by: Martin Kletzander <mkletzan@redhat.com>
---
 src/libxl/libxl_logger.c | 7 +++----
 1 file changed, 3 insertions(+), 4 deletions(-)

--- a/src/libxl/libxl_logger.c
+++ b/src/libxl/libxl_logger.c
@@ -154,23 +154,19 @@ libxlLoggerNew(const char *logDir, virLo
     }
     logger.logDir = logDir;
 
-    if ((logger.files = virHashCreate(3, libxlLoggerFileFree)) == NULL)
-        return NULL;
-
     path = g_strdup_printf("%s/libxl-driver.log", logDir);
 
     if ((logger.defaultLogFile = fopen(path, "a")) == NULL)
-        goto error;
+        goto cleanup;
+
+    if ((logger.files = virHashCreate(3, libxlLoggerFileFree)) == NULL)
+        goto cleanup;
 
     logger_out = XTL_NEW_LOGGER(libvirt, logger);
 
- cleanup:
+cleanup:
     VIR_FREE(path);
     return logger_out;
-
- error:
-    virHashFree(logger.files);
-    goto cleanup;
 }
 
 void
